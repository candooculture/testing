<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Workforce Productivity</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <h1>Workforce Productivity</h1>
  <div class="info-banner">
    <strong>Weâ€™ve pre-filled your industry averages to save you time.</strong><br>
    These reflect common performance in your sector.<br>
    <em>Have your own data?</em> Just update the fields to sharpen your results.
  </div>
  <form id="productivity-form">
    <label for="industry">Industry:</label>
    <select name="industry" id="industry" required>
      <option value="">Select your industry</option>
      <option value="Agriculture / Farming">Agriculture / Farming</option>
      <option value="Construction">Construction</option>
      <option value="Education & Training">Education & Training</option>
      <option value="Finance & Insurance">Finance & Insurance</option>
      <option value="Government / Public Sector">Government / Public Sector</option>
      <option value="Healthcare">Healthcare</option>
      <option value="Hospitality">Hospitality</option>
      <option value="Integrated Services">Integrated Services</option>
      <option value="Logistics & Transport">Logistics & Transport</option>
      <option value="Manufacturing">Manufacturing</option>
      <option value="Media / Creative / Comms">Media / Creative / Comms</option>
      <option value="Non-Profit">Non-Profit</option>
      <option value="Professional Services">Professional Services</option>
      <option value="Real Estate & Property">Real Estate & Property</option>
      <option value="Retail">Retail</option>
      <option value="Technology / SaaS">Technology / SaaS</option>
      <option value="Utilities / Energy / Waste">Utilities / Energy / Waste</option>
    </select>

    <label for="total_revenue">Total Annual Revenue (AUD):</label>
    <input type="number" name="total_revenue" id="total_revenue" required>

    <label for="payroll_cost">Total Payroll Cost (AUD):</label>
    <input type="number" name="payroll_cost" id="payroll_cost" required>

    <label for="total_employees">Number of Employees:</label>
    <input type="number" name="total_employees" id="total_employees" required>

    <label for="productive_hours">Total Productive Hours Worked (All Staff, This Month):</label>
    <input type="number" name="productive_hours" id="productive_hours" required>
    <small>e.g., 15 staff Ã— 140 hrs = 2,100 hrs</small>

    <label for="target_hours">Target Hours per Employee:</label>
    <input type="number" name="target_hours_per_employee" id="target_hours" required>
    <span class="benchmark-label" id="label-hours">(Using industry average)</span>

    <label for="absenteeism_days">Total Days Lost to Absenteeism (All Staff, Per Month):</label>
    <input type="number" name="absenteeism_days" id="absenteeism_days" required>
    <span class="benchmark-label" id="label-absent">(Using industry average)</span>
    <small>e.g., if 5 employees took 1 sick day each, enter 5</small>

    <label for="overtime_hours">Total Overtime Hours Paid (This Month, All Staff):</label>
    <input type="number" name="overtime_hours" id="overtime_hours">
    <small>Include paid overtime only, not time in lieu</small>

    <button type="submit">Calculate</button>
  </form>
  <p style="font-size:14px; color:#666; margin-top:-10px; margin-bottom:20px;">
    The following results reflect potential performance insights, based on typical industry benchmarks and Candooâ€™s proprietary logic.
  </p>
  <pre id="productivity-result"></pre>
  <div class="cta" id="cta-bottom">
    <h3>ğŸŒŸ Seeing the numbers is the start. Now turn them into action.</h3>
    <button onclick="window.location.href='tel:+61YOURNUMBER'">ğŸ“ Book a Strategy Call</button>
    <button onclick="window.location.href='mailto:admin@candooculture.com?subject=Workforce%20Productivity%20-%20Next%20Steps'">
      ğŸ“§ Prefer Email? Letâ€™s Help You Understand What to Do Next
    </button>
  </div>
  <script>
    (() => {
      const MODULE = "workforce-productivity";
      const API_BASE = "https://testing-gh0h.onrender.com";
      const form = document.getElementById("productivity-form");
      const industrySelect = document.getElementById("industry");
      const targetInput = document.getElementById("target_hours");
      const absentInput = document.getElementById("absenteeism_days");
      const labelHours = document.getElementById("label-hours");
      const labelAbsent = document.getElementById("label-absent");
      const resultBox = document.getElementById("productivity-result");
      const cta = document.getElementById("cta-bottom");

      function markPrefilled(input, label, value) {
        if (input.value.trim() === "") {
          input.value = value;
          input.classList.add("prefilled");
          label.style.display = "block";
        }
      }

      function clearOnEdit(input, label) {
        input.addEventListener("input", () => {
          input.classList.remove("prefilled");
          label.style.display = "none";
        });
      }

      clearOnEdit(targetInput, labelHours);
      clearOnEdit(absentInput, labelAbsent);

      async function fetchBenchmarks(industry) {
        try {
          const res = await fetch(`${API_BASE}/get-industry-benchmarks?industry=${encodeURIComponent(industry)}`);
          const data = await res.json();
          if (data.target_hours_per_employee != null) markPrefilled(targetInput, labelHours, data.target_hours_per_employee);
          if (data.absenteeism_days != null) markPrefilled(absentInput, labelAbsent, data.absenteeism_days);
        } catch (err) {
          console.error(`[${MODULE}] Benchmark fetch failed`, err);
        }
      }

      industrySelect.addEventListener("change", () => {
        const selected = industrySelect.value;
        localStorage.setItem("industry", selected);

        document.querySelectorAll('select[name="industry"]').forEach(dropdown => {
          if (dropdown !== industrySelect) dropdown.value = selected;
        });

        fetchBenchmarks(selected);
        window.dispatchEvent(new CustomEvent("benchmark-autofill", {
          detail: { source: MODULE, industry: selected }
        }));
      });

      window.addEventListener("benchmark-autofill", e => {
        const { source, industry } = e.detail || {};
        if (source === MODULE) return;
        if (industrySelect.value !== industry) {
          industrySelect.value = industry;
          fetchBenchmarks(industry);
        }
      });

      const saved = localStorage.getItem("industry");
      if (saved) {
        industrySelect.value = saved;
        fetchBenchmarks(saved);
      }

      let lastIndustry = saved || "";
      setInterval(() => {
        const current = localStorage.getItem("industry");
        if (current && current !== lastIndustry) {
          lastIndustry = current;
          industrySelect.value = current;
          fetchBenchmarks(current);
        }
      }, 1000);

      form.addEventListener("submit", async e => {
        e.preventDefault();
        resultBox.style.display = "none";
        cta.style.display = "none";

        const data = Object.fromEntries(new FormData(form).entries());
        Object.keys(data).forEach(k => { if (!isNaN(data[k])) data[k] = Number(data[k]); });
        data.last_updated = Date.now();
        localStorage.setItem(`${MODULE}-inputs`, JSON.stringify(data));
        window.dispatchEvent(new Event("storage"));
        window.dispatchEvent(new CustomEvent("module-status-updated"));

        try {
          const res = await fetch(`${API_BASE}/run-workforce-productivity`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });

          const result = await res.json();
          if (result.formatted_labels) {
            const r = result.formatted_labels;
            let out = `ğŸ“Š Workforce Productivity Overview\n\n`;
            out += `ğŸ“œ Annual Revenue per Employee: ${r.revenue_per_employee}\n`;
            out += `ğŸ’ª Payroll Efficiency: ${r.payroll_efficiency}\n\t(Each $1 spent on payroll generates ${(parseFloat(r.payroll_efficiency) / 100).toFixed(2)} in revenue)\n\n`;
            out += `ğŸ—ï¸ Utilisation Rate: ${r.utilisation_rate} of target hours used\n`;
            out += `ğŸ›Œ Absenteeism Rate: ${r.absenteeism_rate} of total monthly workdays\n\tâš ï¸ Confirm: days lost is total across entire workforce\n`;
            out += `ğŸ”¥ Overtime Rate: ${r.overtime_rate} of productive hours\n\n`;
            out += `ğŸš€ Opportunity Gain (from 5% Utilisation Uplift): ${r.opportunity_gain}\n\tAssumes additional 5% of target hours at current revenue/hour`;

            resultBox.innerText = out;
            resultBox.style.display = "block";
            cta.style.display = "block";
          } else {
            resultBox.innerText = "Something went wrong.";
            resultBox.style.display = "block";
          }
        } catch (err) {
          console.error(`[${MODULE}] API error`, err);
          resultBox.innerText = "API error. Try again.";
          resultBox.style.display = "block";
        }
      });
    })();
  </script>
  <script src="clarity-core.js"></script>
</body>
</html>
