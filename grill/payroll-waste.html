<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Payroll Waste</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="clarity-style.css" />
</head>

<body>
  <h1>Payroll Waste</h1>

  <div class="info-banner">
    <p>Payroll waste occurs when teams are underused, misaligned, or stalled by poor process. This tool estimates the
      real cost of that underutilisation using industry benchmarks, your salary spend, and a healthy pinch of clarity.
    </p>
  </div>

  <form id="efficiency-form">
    <label for="industry">Industry</label>
    <select id="industry" name="industry">
      <option value="">Select an industry</option>
      <option value="Professional Services">Professional Services</option>
      <option value="Tech & Software">Tech & Software</option>
      <option value="Healthcare">Healthcare</option>
      <option value="Education">Education</option>
      <option value="Hospitality">Hospitality</option>
    </select>

    <label for="total_employees">Total Employees</label>
    <input type="number" id="total_employees" name="total_employees" placeholder="e.g. 50" />

    <label for="avg_salary">Average Salary ($AUD)</label>
    <input type="number" id="avg_salary" name="avg_salary" placeholder="e.g. 85000" />

    <label for="efficiency_pct">Estimated Efficiency (%)</label>
    <input type="number" id="efficiency_pct" name="efficiency_pct" placeholder="e.g. 75" />

    <button type="submit">Calculate</button>
  </form>

  <pre id="results" class="content hidden" style="white-space: pre-wrap;"></pre>

  <script>
    function autoFillBenchmarks(industry) {
      fetch("https://testing-gh0h.onrender.com/benchmarks/payroll-waste?industry=" + encodeURIComponent(industry))
        .then(response => response.json())
        .then(data => {
          if (data && data.benchmark) {
            const { efficiency_pct } = data.benchmark;
            document.getElementById("efficiency_pct").value = efficiency_pct;
            document.getElementById("efficiency_pct").classList.add("prefilled");
          }
        })
        .catch(err => console.error("Benchmark fetch failed:", err));
    }

    function triggerBenchmarkAutofill() {
      const industrySelect = document.getElementById("industry");
      if (!industrySelect) return;
      const selected = industrySelect.value;
      if (!selected) return;
      autoFillBenchmarks(selected);
    }

    window.addEventListener("benchmark-autofill", triggerBenchmarkAutofill);

    window.addEventListener("DOMContentLoaded", () => {
      const savedIndustry = sessionStorage.getItem("industry");
      if (savedIndustry) {
        const dropdown = document.getElementById("industry");
        dropdown.value = savedIndustry;
        dropdown.dispatchEvent(new Event("change"));
      }

      const form = document.getElementById("efficiency-form");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const industry = document.getElementById("industry").value;
        const total_employees = parseInt(document.getElementById("total_employees").value, 10);
        const avg_salary = parseFloat(document.getElementById("avg_salary").value);
        const efficiency_pct = parseFloat(document.getElementById("efficiency_pct").value);

        const response = await fetch("https://testing-gh0h.onrender.com/calculate/payroll-waste", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ industry, total_employees, avg_salary, efficiency_pct }),
        });

        const result = await response.json();
        const resultBox = document.getElementById("results");

        if (result.formatted_labels) {
          const r = result.formatted_labels;
          let out = `ðŸ§¾ Snapshot of Monthly Team Drag\n\n`;
          out += `ðŸ’¸ Total Waste: ${r["Total Monthly Loss"]}\n`;
          out += `â€ƒâ€¢ Inefficiency: ${r["Payroll Inefficiency Cost"]}\n`;
          out += `â€ƒâ€¢ Employee Churn Cost: ${r["Employee Churn Cost"]}\n\n`;
          out += `âœ… Based on Your Inputs\n`;
          out += `ðŸŽ¯ Projected Monthly Savings: ${r["Direct Savings from Initiative"]}\n`;
          out += `â€ƒâ€¢ New Inefficiency Cost: ${r["Improved Inefficiency Cost"]}\n\n`;
          out += `ðŸ“ˆ Strategic Investment ROI with Candoo\n`;
          out += `ðŸ’° Projected Return on Every $1 Invested: ${r["Return Per Dollar"]}\n`;
          out += `â± Time to Recover Your Investment: ${r["Payback Period"]}\n\n`;
          out += `ðŸ“Š Benchmark Check â€” ${result.data.industry} Industry\n`;
          result.benchmark_messages.forEach(msg => { out += `- ${msg}\n`; });
          out += `\nðŸ§  Straight Talk\n`;
          out += `You're currently leaking ${r["Total Monthly Loss"]} each month in team inefficiency and churn.\n`;
          out += `Even a ${result.data.improvement_rate}% improvement unlocks ${r["Direct Savings from Initiative"]} â€” straight off your payroll costs.`;

          resultBox.innerText = out;
          resultBox.classList.remove("hidden");
        } else {
          resultBox.innerText = "Something went wrong.";
          resultBox.classList.remove("hidden");
        }
      });

      const industrySelect = document.getElementById("industry");
      industrySelect.addEventListener("change", () => {
        const selected = industrySelect.value;
        if (selected) {
          sessionStorage.setItem("industry", selected);
          document.querySelectorAll('select[name="industry"]').forEach(dropdown => {
            dropdown.value = selected;
            dropdown.dispatchEvent(new Event("change"));
          });
          window.dispatchEvent(new Event("benchmark-autofill"));
        }
      });
    });
  </script>
</body>

</html>