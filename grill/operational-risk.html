<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Operational Risk Score</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;600&display=swap" rel="stylesheet" />
  <link href="clarity-style.css" rel="stylesheet" />
</head>
<body>
  <h1>Operational Risk Score</h1>

  <div class="info-banner">
    <strong>This tool combines inputs from all other modules.</strong><br/>
    Complete Payroll, Churn, Leadership, Workforce, and Deep Dive — then hit the button below to calculate your risk score.
  </div>

  <div class="status-box" id="riskSummary">⏳ Checking module completion...</div>
  <div class="status-box">
    <p>Payroll Waste: <span id="status-payroll">❌</span></p>
    <p>Customer Churn: <span id="status-churn">❌</span></p>
    <p>Leadership Drag: <span id="status-leadership">❌</span></p>
    <p>Workforce Productivity: <span id="status-workforce">❌</span></p>
    <p>Deep Dive: <span id="status-deepdive">❌</span></p>
  </div>

  <button id="generate-risk-btn">🚀 Generate Operational Risk Score</button>
  <pre id="op-risk-result"></pre>
  <button class="reset-btn" id="reset-btn">🔄 Reset All Module Results</button>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const STATUS_BOX = document.getElementById("riskSummary");
      const RESULT_BOX = document.getElementById("op-risk-result");

      const keys = {
        payroll: "payroll-waste-inputs",
        churn: "customer-churn-inputs",
        leadership: "leadership-drag-inputs",
        productivity: "workforce-productivity-inputs",
        dive: "productivity-deep-dive-inputs"
      };

      const spanMap = {
        "payroll-waste-inputs": "status-payroll",
        "customer-churn-inputs": "status-churn",
        "leadership-drag-inputs": "status-leadership",
        "workforce-productivity-inputs": "status-workforce",
        "productivity-deep-dive-inputs": "status-deepdive"
      };

      function updateDetailedModuleStatus() {
        Object.entries(spanMap).forEach(([key, spanId]) => {
          const span = document.getElementById(spanId);
          if (!span) return;
          try {
            const item = JSON.parse(localStorage.getItem(key));
            span.textContent = item && typeof item === "object" && Object.keys(item).length > 0 ? "✅" : "❌";
          } catch {
            span.textContent = "❌";
          }
        });
      }

      function updateOverallStatusBox() {
        const count = Object.keys(spanMap).filter(key => {
          try {
            const data = JSON.parse(localStorage.getItem(key));
            return data && typeof data === "object" && Object.keys(data).length > 0;
          } catch {
            return false;
          }
        }).length;

        STATUS_BOX.innerText = count === 5
          ? "✅ All modules complete. Ready to calculate."
          : `❌ ${count}/5 modules complete.`;
      }

      async function runORS() {
        updateDetailedModuleStatus();
        updateOverallStatusBox();

        const modules = {
          payroll: JSON.parse(localStorage.getItem(keys.payroll) || "null"),
          churn: JSON.parse(localStorage.getItem(keys.churn) || "null"),
          leadership: JSON.parse(localStorage.getItem(keys.leadership) || "null"),
          productivity: JSON.parse(localStorage.getItem(keys.productivity) || "null"),
          dive: JSON.parse(localStorage.getItem(keys.dive) || "null")
        };

        const completed = Object.values(modules).filter(val => val !== null);
        if (completed.length < 5) {
          STATUS_BOX.innerText = `❌ ${completed.length}/5 modules complete.`;
          RESULT_BOX.innerText = "Please complete all 5 modules before calculating.";
          RESULT_BOX.style.display = "block";
          return;
        }

        STATUS_BOX.innerText = "✅ 5 of 5 modules complete. Calculating...";

        const payload = {
          industry: modules.payroll.industry || "",
          total_employees: modules.payroll.total_employees || modules.productivity.total_employees || 0,
          avg_salary: modules.payroll.avg_salary || modules.dive.avg_salary || 0,
          improvement_rate: modules.payroll.improvement_rate || 0,
          churn_rate: modules.churn.churn_rate || 0,
          desired_improvement: modules.churn.desired_improvement || 0,
          cac: modules.churn.cac || 0,
          avg_revenue: modules.churn.avg_revenue || 0,
          num_customers: modules.churn.num_customers || 0,
          leadership_drag: modules.leadership.leadership_drag || 0,
          total_revenue: modules.productivity.total_revenue || 0,
          payroll_cost: modules.productivity.payroll_cost || 0,
          productive_hours: modules.productivity.productive_hours || 0,
          target_hours_per_employee: modules.productivity.target_hours_per_employee || 0,
          absenteeism_days: modules.productivity.absenteeism_days || modules.dive.absenteeism_days || 0,
          overtime_hours: modules.productivity.overtime_hours || 0,
          avg_hours: modules.dive.avg_hours || 0
        };

        try {
          const res = await fetch("https://testing-gh0h.onrender.com/run-operational-risk", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const result = await res.json();

          if (result.formatted_labels) {
            let output = `📉 Operational Risk Summary:\n\n`;
            for (const [key, value] of Object.entries(result.formatted_labels)) {
              output += `• ${key}: ${value}\n`;
            }
            output += `\n🧠 Straight Talk\n${result.straight_talk || "No commentary provided."}`;
            RESULT_BOX.innerText = output;
          } else {
            RESULT_BOX.innerText = "⚠️ Something went wrong. No formatted_labels returned.";
          }
        } catch (err) {
          console.error("[ORS ERROR]", err);
          RESULT_BOX.innerText = "❌ Failed to run analysis. Try again.";
        }

        RESULT_BOX.style.display = "block";
      }

      function resetAll() {
        Object.keys(spanMap).forEach(k => localStorage.removeItem(k));
        localStorage.removeItem("industry");
        location.reload();
      }

      document.getElementById("generate-risk-btn").addEventListener("click", runORS);
      document.getElementById("reset-btn").addEventListener("click", resetAll);

      updateDetailedModuleStatus();
      updateOverallStatusBox();

      let lastModuleStates = {};
      setInterval(() => {
        let changed = false;
        Object.keys(spanMap).forEach(key => {
          const current = localStorage.getItem(key);
          if (lastModuleStates[key] !== current) {
            lastModuleStates[key] = current;
            changed = true;
          }
        });
        if (changed) {
          updateDetailedModuleStatus();
          updateOverallStatusBox();
        }
      }, 1000);
    });
  </script>
</body>
</html>
