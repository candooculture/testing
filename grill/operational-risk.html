<h2>Operational Risk Report</h2>

<div id="report-form">
  <label for="email">Recipient Email:</label>
  <input type="email" id="email" placeholder="you@example.com" required />
  <button id="generate-btn">Generate Report</button>
</div>

<p id="feedback"></p>

<script>
  const emailInput = document.getElementById("email");
  const feedback = document.getElementById("feedback");
  const btn = document.getElementById("generate-btn");

  const read = (key) => {
    try { return JSON.parse(localStorage.getItem(key)) || {}; }
    catch { return {}; }
  };

  btn.addEventListener("click", async (e) => {
    e.preventDefault();

    const email = emailInput.value.trim();
    if (!email) {
      feedback.textContent = "Please enter a valid email address.";
      feedback.style.color = "orange";
      return;
    }

    const payroll = read("payroll-waste-inputs");
    const churn = read("customer-churn-inputs");
    const leadership = read("leadership-drag-inputs");
    const workforce = read("workforce-productivity-inputs");
    const deep = read("productivity-deep-dive-inputs");

    const payload = {
      recipient: email,
      subject: "Candoo: Your Operational Risk Report",
      industry: payroll.industry || workforce.industry || "",
      improvement_rate: payroll.improvement_rate,
      payroll_cost: workforce.payroll_cost,
      total_employees: payroll.total_employees,
      avg_salary: payroll.avg_salary,
      churn_rate: churn.churn_rate,
      desired_improvement: churn.desired_improvement,
      cac: churn.cac,
      avg_revenue: churn.avg_revenue,
      num_customers: churn.num_customers,
      leadership_drag: leadership.leadership_drag,
      total_revenue: workforce.total_revenue,
      productive_hours: workforce.productive_hours,
      target_hours_per_employee: workforce.target_hours_per_employee,
      overtime_hours: workforce.overtime_hours,
      absenteeism_days: deep.absenteeism_days,
      avg_hours: deep.avg_hours
    };

    try {
      const response = await fetch("https://testing-gh0h.onrender.com/send-risk-report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const result = await response.json();
      console.log("📬 Server response:", result);

      // NEW: save EBITDA-at-risk to localStorage for the Profit page
      const orsVal =
        (result?.results?.total_risk_dollars) ??
        (result?.results?.ebitdaAtRisk) ??
        (result?.total_ors_ebitda_risk) ??
        (result?.total_risk_impact) ??
        (result?.ebitda_at_risk) ?? 0;
      saveOrsRisk(orsVal); // <- this calls the helper you already added at the bottom

      if (response.ok) {
        feedback.textContent = "✅ Report sent successfully!";
        feedback.style.color = "green";
        emailInput.value = "";
      } else {
        throw new Error(result.detail || "Failed to send report.");
      }
    } catch (err) {
      console.error("❌ Fetch failed:", err);
      feedback.textContent = `❌ ${err.message}`;
      feedback.style.color = "red";
    }
  });
</script>

<script>
// 1) tiny helper
function saveOrsRisk(v) {
  const n = Number(String(v).replace(/,/g, ''));
  if (!Number.isFinite(n) || n <= 0) return;
  localStorage.setItem('ors_ebitda_at_risk', String(n));
  // nudge other tabs/views
  try { window.dispatchEvent(new Event('storage')); } catch(_) {}
}
</script>

<script>
/* Capture ANY JSON response on this page and save ORS ($) to localStorage */
(function () {
  function setRisk(val) {
    const n = Number(String(val).replace(/,/g, ''));
    if (Number.isFinite(n) && n > 0) {
      localStorage.setItem('ors_ebitda_at_risk', String(n));
      // poke this page; other tabs will read on their reload
      try { window.dispatchEvent(new Event('storage')); } catch (_) {}
      console.log("💾 Saved ors_ebitda_at_risk:", n);
    }
  }
  function findRisk(obj) {
    if (!obj || typeof obj !== 'object') return null;
    // Try your common backend field names. Add more if your response shape differs.
    const keys = [
      "total_risk_dollars",
      "total_ors_ebitda_risk",
      "total_risk_impact",
      "ebitda_at_risk",
      "ebitdaAtRisk"
    ];
    for (const k of keys) if (obj[k] != null) return obj[k];
    if (obj.results) return findRisk(obj.results);
    return null;
  }
  const origFetch = window.fetch;
  window.fetch = async function (...args) {
    const res = await origFetch.apply(this, args);
    try {
      const clone = res.clone();
      const ct = (clone.headers.get('content-type') || '').toLowerCase();
      if (ct.includes('application/json')) {
        const data = await clone.json();
        const val = findRisk(data);
        if (val != null) setRisk(val);
      }
    } catch (_) {}
    return res;
  };
})();
</script>

