<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Operational Risk</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'DM Sans', sans-serif;
      background-color: #ffffff;
      color: #333333;
      padding: 40px 20px;
      max-width: 600px;
      margin: auto;
      line-height: 1.6;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
      font-weight: 700;
    }

    .info-banner {
      background-color: #f1f1f1;
      padding: 15px;
      margin-bottom: 25px;
      border-left: 4px solid #48f191;
      font-size: 14px;
    }

    ul {
      list-style: none;
      padding-left: 0;
    }

    li {
      margin: 8px 0;
      font-size: 16px;
    }

    .complete {
      color: green;
    }

    .missing {
      color: #c00;
    }

    .result-box,
    .status-box {
      margin-top: 20px;
      padding: 15px;
      border: 1px dashed #ccc;
      border-radius: 8px;
      background: #f9f9f9;
    }

    .result-box {
      display: none;
      white-space: pre-wrap;
    }

    .cta {
      margin-top: 30px;
      display: none;
      text-align: center;
    }

    .cta button {
      display: block;
      margin: 10px auto;
      padding: 10px 18px;
      border-radius: 6px;
      border: none;
      background: #48f191;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }

    .run-btn {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border: none;
      border-radius: 6px;
      background: #48f191;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
    }

    .reset-btn {
      background: #eee;
      color: #333;
      border: 1px solid #bbb;
      font-size: 14px;
      margin-top: 20px;
      width: 100%;
      padding: 10px;
      border-radius: 6px;
    }
  </style>
</head>

<body>
  <h1>Operational Risk Score</h1>

  <div class="info-banner">
    <strong>This tool combines inputs from other modules to reveal your operational risk profile.</strong><br>
    Make sure you've run the other modules first â€” weâ€™ll analyse the data youâ€™ve entered so far.
  </div>

  <ul id="moduleStatusList"></ul>
  <div id="statusBox" class="status-box">Checking modules...</div>

  <button id="runORSBtn" class="run-btn" style="display:none;">ðŸš¦ Generate Operational Risk Score</button>

  <pre id="orsResult" class="result-box"></pre>

  <div id="cta-bottom" class="cta">
    <h3>ðŸ“‰ See the full picture â€” and where youâ€™re exposed.</h3>
    <button onclick="window.location.href='tel:+61YOURNUMBER'">ðŸ“ž Book a Strategy Call</button>
    <button
      onclick="window.location.href='mailto:admin@candooculture.com?subject=Help Me Understand My Operational Risk Score'">ðŸ“§
      Prefer Email? Letâ€™s Help You Understand What to Do Next</button>
  </div>

  <button class="reset-btn" onclick="resetAll()">ðŸ”„ Reset All Module Results</button>

  <script>
    (() => {
      const MODULE_KEYS = [
        "payroll-waste-inputs",
        "customer-churn-inputs",
        "leadership-drag-inputs",
        "workforce-productivity-inputs",
        "productivity-deep-dive-inputs"
      ];

      const API_BASE = "https://testing-gh0h.onrender.com";

      const statusBox = document.getElementById("statusBox");
      const resultBox = document.getElementById("orsResult");
      const cta = document.getElementById("cta-bottom");
      const runBtn = document.getElementById("runORSBtn");
      const statusList = document.getElementById("moduleStatusList");

      function read(key) {
        try {
          return JSON.parse(localStorage.getItem(key)) || null;
        } catch {
          return null;
        }
      }

      function updateModuleStatus() {
        let allComplete = true;
        statusList.innerHTML = "";

        MODULE_KEYS.forEach(key => {
          const data = read(key);
          const li = document.createElement("li");
          if (data) {
            li.innerHTML = `âœ… ${key.replace(/-inputs$/, '').replace(/-/g, ' ')}`;
            li.className = "complete";
          } else {
            li.innerHTML = `âŒ ${key.replace(/-inputs$/, '').replace(/-/g, ' ')}`;
            li.className = "missing";
            allComplete = false;
          }
          statusList.appendChild(li);
        });

        if (allComplete) {
          statusBox.innerText = "âœ… All 5 modules complete. Ready to generate risk score.";
          runBtn.style.display = "block";
        } else {
          statusBox.innerText = "âš ï¸ Some modules are incomplete. Complete all before generating risk score.";
          runBtn.style.display = "none";
        }
      }

      runBtn.addEventListener("click", async () => {
        const data = {};
        MODULE_KEYS.forEach(key => data[key] = read(key));
        resultBox.style.display = "none";
        cta.style.display = "none";

        try {
          const res = await fetch(`${API_BASE}/run-operational-risk`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });

          const result = await res.json();

          if (result.formatted_labels) {
            let output = "ðŸ“Š Operational Risk Profile:\n\n";
            Object.entries(result.formatted_labels).forEach(([label, value]) => {
              output += `- ${label}: ${value}\n`;
            });
            output += `\nðŸ§  Straight Talk\n${result.straight_talk}`;
            resultBox.innerText = output;
            resultBox.style.display = "block";
            cta.style.display = "block";
          } else {
            resultBox.innerText = "Something went wrong. (No formatted_labels)";
            resultBox.style.display = "block";
          }
        } catch (err) {
          console.error("[ORS] API error", err);
          resultBox.innerText = "Something went wrong. (API error)";
          resultBox.style.display = "block";
        }
      });

      window.resetAll = () => {
        MODULE_KEYS.forEach(key => localStorage.removeItem(key));
        window.location.reload();
      };

      updateModuleStatus();
    })();
  </script>
</body>

</html>
