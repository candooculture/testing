<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Operational Risk Score</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'DM Sans', sans-serif;
      background-color: #ffffff;
      color: #333;
      padding: 40px 20px;
      max-width: 600px;
      margin: auto;
      line-height: 1.6;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
      font-weight: 700;
    }

    .info-banner {
      background-color: #f1f1f1;
      padding: 15px;
      margin-bottom: 25px;
      border-left: 4px solid #48f191;
      font-size: 14px;
    }

    .status-box {
      background: #f9f9f9;
      border: 1px dashed #ccc;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .result-box {
      display: block;
      white-space: pre-wrap;
      background: #fefefe;
      border-left: 4px solid #48f191;
      padding: 24px;
      border-radius: 10px;
      font-size: 15px;
      margin-top: 20px;
    }

    button {
      display: block;
      width: 100%;
      margin-top: 20px;
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-family: inherit;
      transition: background-color 0.2s ease-in-out;
    }

    #ors-button {
      background: #48f191;
      color: #000;
      border: none;
    }

    #ors-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #reset-all {
      background: #eee;
      color: #333;
      border: 1px solid #bbb;
    }
  </style>
</head>
<body>
  <h1>Operational Risk Score</h1>

  <div class="info-banner">
    <strong>This tool combines inputs from other modules to reveal your operational risk profile.</strong><br>
    Make sure you've run the other modules first ‚Äî we‚Äôll analyse the data you've entered so far.
  </div>

  <div id="ors-status" class="status-box">Checking modules...</div>
  <button id="ors-button" disabled>üöÄ Generate Operational Risk Score</button>
  <pre id="ors-result" class="result-box">‚è≥ Waiting to run analysis...</pre>
  <button id="reset-all">üîÑ Reset All Module Results</button>

  <script>
    (() => {
      const MODULE_KEYS = [
        "payroll-waste-inputs",
        "customer-churn-inputs",
        "leadership-drag-inputs",
        "workforce-productivity-inputs",
        "productivity-deep-dive-inputs"
      ];

      const API_URL = "https://testing-gh0h.onrender.com/run-operational-risk";
      const resultBox = document.getElementById("ors-result");
      const statusBox = document.getElementById("ors-status");
      const button = document.getElementById("ors-button");
      const resetBtn = document.getElementById("reset-all");

      function getModuleStatus() {
        return MODULE_KEYS.map(key => {
          const data = localStorage.getItem(key);
          return {
            key,
            complete: !!data && data !== "undefined",
            data: data ? JSON.parse(data) : null
          };
        });
      }

      function renderStatus(modules) {
        const allComplete = modules.every(m => m.complete);
        let html = "<strong>Module Status:</strong><br><ul style='padding-left: 1em'>";
        modules.forEach(m => {
          const label = m.key.replace("-inputs", "").replace(/-/g, " ");
          html += `<li style="color:${m.complete ? 'green' : 'red'}">‚Ä¢ ${label} ‚Äî ${m.complete ? '‚úÖ Complete' : '‚ùå Pending'}</li>`;
        });
        html += "</ul>";
        html += `<p><strong>${allComplete ? "‚úÖ All modules complete." : "‚ö†Ô∏è Please complete all 5 modules before running."}</strong></p>`;

        statusBox.innerHTML = html;
        button.disabled = !allComplete;
        button.style.opacity = allComplete ? "1" : "0.6";
        return allComplete;
      }

      function flattenPayload(modules) {
        return modules.reduce((acc, mod) => {
          if (mod.complete && mod.data) {
            Object.assign(acc, mod.data);
          }
          return acc;
        }, {});
      }

      async function generateORS() {
        const modules = getModuleStatus();
        const payload = flattenPayload(modules);
        resultBox.innerText = "‚è≥ Generating Operational Risk Score...";

        try {
          const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const result = await res.json();

          if (result.formatted_labels) {
            let output = "üìä Operational Risk Profile:\n\n";
            Object.entries(result.formatted_labels).forEach(([label, value]) => {
              output += `- ${label}: ${value}\n`;
            });
            output += `\nüß† Straight Talk\n${result.straight_talk || "No commentary provided."}`;
            resultBox.innerText = output;
          } else {
            resultBox.innerText = "‚ö†Ô∏è Something went wrong. No formatted_labels returned.";
          }
        } catch (err) {
          console.error("[ORS Error]", err);
          resultBox.innerText = "‚ùå Error generating score. Check console for details.";
        }
      }

      // Hook up generate button
      button.addEventListener("click", generateORS);

      // Hook up reset button
      resetBtn.addEventListener("click", () => {
        MODULE_KEYS.forEach(k => localStorage.removeItem(k));
        location.reload();
      });

      // Init
      const currentModules = getModuleStatus();
      renderStatus(currentModules);
    })();
  </script>
</body>
</html>
