<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Operational Risk</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'DM Sans', sans-serif;
      background-color: #ffffff;
      color: #333333;
      padding: 40px 20px;
      max-width: 600px;
      margin: auto;
      line-height: 1.6;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
      font-weight: 700;
    }

    .info-banner {
      background-color: #f1f1f1;
      padding: 15px;
      margin-bottom: 25px;
      border-left: 4px solid #48f191;
      font-size: 14px;
    }

    ul {
      list-style: none;
      padding-left: 0;
    }

    li {
      margin: 8px 0;
      font-size: 16px;
    }

    .complete {
      color: green;
    }

    .pending {
      color: #888;
    }

    .result-box,
    .status-box {
      margin-top: 20px;
      padding: 15px;
      border: 1px dashed #ccc;
      border-radius: 8px;
      background: #f9f9f9;
    }

    .result-box {
      display: none;
      white-space: pre-wrap;
    }

    .cta {
      margin-top: 30px;
      display: none;
      text-align: center;
    }

    .cta button {
      display: block;
      margin: 10px auto;
      padding: 10px 18px;
      border-radius: 6px;
      border: none;
      background: #48f191;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }

    .reset-btn {
      background: #eee;
      color: #333;
      border: 1px solid #bbb;
      font-size: 14px;
      margin-top: 20px;
      width: 100%;
      padding: 10px;
      border-radius: 6px;
    }
  </style>
</head>

<body>
  <h1>Operational Risk Score</h1>

  <div class="info-banner">
    <strong>This tool combines inputs from other modules to reveal your operational risk profile.</strong><br>
    Make sure you've run the other modules first ‚Äî we'll analyse the data you've entered so far.
  </div>

  <ul id="moduleStatusList"></ul>
  <div id="riskSummary" class="status-box">‚è≥ Waiting for modules to complete...</div>
  <pre id="op-risk-result" class="result-box"></pre>

  <button class="reset-btn" onclick="resetAll()">üîÑ Reset All Module Results</button>

  <div id="cta-bottom" class="cta">
    <h3>üìâ See the full picture ‚Äî and where you‚Äôre exposed.</h3>
    <button onclick="window.location.href='tel:+61YOURNUMBER'">üìû Book a Strategy Call</button>
    <button
      onclick="window.location.href='mailto:admin@candooculture.com?subject=Help Me Understand My Operational Risk Score'">üìß
      Prefer Email? Let‚Äôs Help You Understand What to Do Next</button>
  </div>

  <script>
(() => {
  const MODULE = "operational-risk";
  const API_BASE = "https://testing-gh0h.onrender.com";
  const RESULT_BOX = document.getElementById("ors-result");
  const STATUS_BOX = document.getElementById("ors-status");

  function read(key) {
    try {
      return JSON.parse(localStorage.getItem(key)) || null;
    } catch (err) {
      return null;
    }
  }

  function show(msg) {
    RESULT_BOX.innerText = msg;
    RESULT_BOX.style.display = "block";
  }

  async function runORS() {
    const keys = [
      "payroll-waste-inputs",
      "customer-churn-inputs",
      "leadership-drag-inputs",
      "workforce-productivity-inputs",
      "productivity-deep-dive-inputs"
    ];

    const data = {};
    let allDone = true;

    for (const key of keys) {
      const moduleData = read(key);
      if (!moduleData) {
        allDone = false;
        console.warn(`[ORS] Missing data: ${key}`);
      } else {
        data[key] = moduleData;
      }
    }

    if (!allDone) {
      STATUS_BOX.innerText = "Not all modules complete.";
      show("You need to finish all 5 modules first.");
      return;
    }

    STATUS_BOX.innerText = "‚è≥ 5 of 5 modules complete.";

    console.log("[ORS] Sending data to API:", data); // <-- üü¢ THIS IS THE DEBUG LOG

    try {
      const res = await fetch(`${API_BASE}/run-operational-risk`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      console.log("[ORS] Received result:", result); // <-- üü¢ DEBUG RESPONSE

      if (result.formatted_labels) {
        let output = "üìä Operational Risk Profile:\n\n";
        Object.entries(result.formatted_labels).forEach(([label, value]) => {
          output += `- ${label}: ${value}\n`;
        });
        output += `\nüß† Straight Talk\n${result.straight_talk}`;
        show(output);
      } else {
        show("Something went wrong. (No formatted_labels)");
      }
    } catch (err) {
      console.error(`[ORS] API error:`, err);
      show("Something went wrong. (API error)");
    }
  }

  document.getElementById("ors-button").addEventListener("click", runORS);
})();
</script>
</body>

</html>
