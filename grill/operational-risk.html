<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Operational Risk Score</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'DM Sans', sans-serif;
      background-color: #ffffff;
      color: #333333;
      padding: 40px 20px;
      max-width: 640px;
      margin: auto;
      line-height: 1.6;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
      font-weight: 700;
    }
    .info-banner {
      background-color: #f1f1f1;
      padding: 15px;
      margin-bottom: 25px;
      border-left: 4px solid #48f191;
      font-size: 14px;
    }
    .status-box {
      font-size: 16px;
      margin-bottom: 20px;
      font-weight: 600;
    }
    .status-box p {
      margin: 4px 0;
      font-weight: normal;
    }
    .status-box span {
      font-weight: bold;
    }
    button {
      display: block;
      margin: 20px auto;
      padding: 12px 20px;
      border-radius: 6px;
      border: none;
      background: #48f191;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    .reset-btn {
      background: #eee;
      color: #333;
      border: 1px solid #bbb;
      font-size: 14px;
      width: 100%;
    }
    pre {
      background-color: #fefefe;
      border-left: 4px solid #48f191;
      padding: 20px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: inherit;
      font-size: 16px;
      color: #333;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      display: none;
    }
  </style>
</head>
<body>
  <h1>Operational Risk Score</h1>

  <div class="info-banner">
    <strong>This tool combines inputs from all other modules.</strong><br />
    Complete Payroll, Churn, Leadership, Workforce, and Deep Dive ‚Äî then hit the button below to calculate your risk score.
  </div>

  <div id="riskSummary" class="status-box">‚è≥ Checking module completion...</div>

  <div class="status-box">
    <p>Payroll Waste: <span id="status-payroll">‚ùå</span></p>
    <p>Customer Churn: <span id="status-churn">‚ùå</span></p>
    <p>Leadership Drag: <span id="status-leadership">‚ùå</span></p>
    <p>Workforce Productivity: <span id="status-workforce">‚ùå</span></p>
    <p>Deep Dive: <span id="status-deepdive">‚ùå</span></p>
  </div>

  <button id="generate-risk-btn">üöÄ Generate Operational Risk Score</button>
  <pre id="op-risk-result"></pre>
  <button id="reset-btn" class="reset-btn">üîÑ Reset All Module Results</button>

  <script>
    (() => {
      const MODULE_KEYS = {
        payroll: "payroll-waste-inputs",
        churn: "customer-churn-inputs",
        leadership: "leadership-drag-inputs",
        productivity: "workforce-productivity-inputs",
        dive: "productivity-deep-dive-inputs"
      };

      function updateDetailedModuleStatus() {
        const map = {
          "payroll-waste-inputs": "status-payroll",
          "customer-churn-inputs": "status-churn",
          "leadership-drag-inputs": "status-leadership",
          "workforce-productivity-inputs": "status-workforce",
          "productivity-deep-dive-inputs": "status-deepdive"
        };

        Object.entries(map).forEach(([key, spanId]) => {
          try {
            const item = JSON.parse(localStorage.getItem(key));
            const isValid = item && typeof item === "object" && Object.keys(item).length > 0;
            document.getElementById(spanId).textContent = isValid ? "‚úÖ" : "‚ùå";
          } catch {
            document.getElementById(spanId).textContent = "‚ùå";
          }
        });
      }

      function updateOverallStatusBox() {
        const statusBox = document.getElementById("riskSummary");
        const keys = Object.values(MODULE_KEYS);
        const count = keys.filter(key => {
          try {
            const data = JSON.parse(localStorage.getItem(key));
            return data && typeof data === "object" && Object.keys(data).length > 0;
          } catch {
            return false;
          }
        }).length;

        statusBox.innerText = count === 5
          ? "‚úÖ All modules complete. Ready to calculate."
          : `‚ùå ${count}/5 modules complete.`;
      }

      function runORS() {
        updateDetailedModuleStatus();
        updateOverallStatusBox();

        const STATUS_BOX = document.getElementById("riskSummary");
        const RESULT_BOX = document.getElementById("op-risk-result");
        const API_BASE = "https://testing-gh0h.onrender.com";

        const payroll = JSON.parse(localStorage.getItem(MODULE_KEYS.payroll) || "null");
        const churn = JSON.parse(localStorage.getItem(MODULE_KEYS.churn) || "null");
        const leadership = JSON.parse(localStorage.getItem(MODULE_KEYS.leadership) || "null");
        const productivity = JSON.parse(localStorage.getItem(MODULE_KEYS.productivity) || "null");
        const dive = JSON.parse(localStorage.getItem(MODULE_KEYS.dive) || "null");

        const modules = { payroll, churn, leadership, productivity, dive };
        const completed = Object.entries(modules).filter(([_, val]) => val !== null);

        if (completed.length < 5) {
          STATUS_BOX.innerText = `‚ùå ${completed.length}/5 modules complete.`;
          RESULT_BOX.innerText = "Please complete all 5 modules before calculating.";
          RESULT_BOX.style.display = "block";
          return;
        }

        STATUS_BOX.innerText = "‚úÖ 5 of 5 modules complete. Calculating...";

        const payload = {
          industry: payroll.industry || "",
          total_employees: payroll.total_employees || productivity.total_employees || 0,
          avg_salary: payroll.avg_salary || dive.avg_salary || 0,
          improvement_rate: payroll.improvement_rate || 0,

          churn_rate: churn.churn_rate || 0,
          desired_improvement: churn.desired_improvement || 0,
          cac: churn.cac || 0,
          avg_revenue: churn.avg_revenue || 0,
          num_customers: churn.num_customers || 0,

          leadership_drag: leadership.leadership_drag || 0,

          total_revenue: productivity.total_revenue || 0,
          payroll_cost: productivity.payroll_cost || 0,
          productive_hours: productivity.productive_hours || 0,
          target_hours_per_employee: productivity.target_hours_per_employee || 0,
          absenteeism_days: productivity.absenteeism_days || dive.absenteeism_days || 0,
          overtime_hours: productivity.overtime_hours || 0,

          avg_hours: dive.avg_hours || 0
        };

        try {
          const res = await fetch(`${API_BASE}/run-operational-risk`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const result = await res.json();

          if (result.formatted_labels) {
            let output = `üìâ Operational Risk Summary:\n\n`;
            for (const [key, value] of Object.entries(result.formatted_labels)) {
              output += `‚Ä¢ ${key}: ${value}\n`;
            }
            output += `\nüß† Straight Talk\n${result.straight_talk || "No commentary provided."}`;
            RESULT_BOX.innerText = output;
          } else {
            RESULT_BOX.innerText = "‚ö†Ô∏è Something went wrong. No formatted_labels returned.";
          }
        } catch (err) {
          console.error("[ORS ERROR]", err);
          RESULT_BOX.innerText = "‚ùå Failed to run analysis. Try again.";
        }

        RESULT_BOX.style.display = "block";
      }

      document.getElementById("generate-risk-btn").addEventListener("click", runORS);

      document.getElementById("reset-btn").addEventListener("click", () => {
        const keys = Object.values(MODULE_KEYS).concat("industry");
        keys.forEach(k => localStorage.removeItem(k));
        location.reload();
      });

      // Listen for live updates from all modules
      window.addEventListener("storage", (event) => {
        if (Object.values(MODULE_KEYS).includes(event.key)) {
          updateDetailedModuleStatus();
          updateOverallStatusBox();
        }
      });

      // Check status when page loads or focus is triggered
      window.addEventListener("load", () => {
        updateDetailedModuleStatus();
        updateOverallStatusBox();
      });
      
      window.addEventListener("focus", () => {
        updateDetailedModuleStatus();
        updateOverallStatusBox();
      });

      window.addEventListener("module-status-updated", () => {
        updateDetailedModuleStatus();
        updateOverallStatusBox();
      });

    })();
  </script>
</body>
</html>
