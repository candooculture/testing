<h2>Operational Risk Report</h2>

<div id="report-form">
  <label for="email">Recipient Email:</label>
  <input type="email" id="email" placeholder="you@example.com" required />
  <button id="generate-btn">Generate Report</button>
</div>

<p id="feedback"></p>

<script>
  // ========================
  // Config
  // ========================
  const BACKEND = "https://testing-gh0h.onrender.com"; // change when you switch environments

  // ========================
  // Elements
  // ========================
  const emailInput = document.getElementById("email");
  const feedback   = document.getElementById("feedback");
  const btn        = document.getElementById("generate-btn");

  // Prefill email if we have one saved
  (function prefillEmail() {
    const savedEmail = localStorage.getItem("candoo-user-email");
    if (savedEmail) emailInput.value = savedEmail;
  })();

  // Read helper for JSON blobs stored by other modules
  const read = (key) => {
    try { return JSON.parse(localStorage.getItem(key)) || {}; }
    catch { return {}; }
  };

  // Save ORS ($) for the Profit page
  function saveOrsRisk(v) {
    const n = Number(String(v).replace(/,/g, ''));
    if (!Number.isFinite(n) || n <= 0) return;
    localStorage.setItem('ors_ebitda_at_risk', String(n));
    try { window.dispatchEvent(new Event('storage')); } catch(_) {}
    console.log("üíæ ors_ebitda_at_risk =", n);
  }

  // ========================
  // Submit handler
  // ========================
  btn.addEventListener("click", async (e) => {
    e.preventDefault();

    const email = emailInput.value.trim();
    if (!email) {
      feedback.textContent = "Please enter a valid email address.";
      feedback.style.color = "orange";
      return;
    }
    // remember email for convenience
    localStorage.setItem("candoo-user-email", email);

    // Collect inputs from other modules
    const payroll    = read("payroll-waste-inputs");
    const churn      = read("customer-churn-inputs");
    const leadership = read("leadership-drag-inputs");
    const workforce  = read("workforce-productivity-inputs");
    const deep       = read("productivity-deep-dive-inputs");

    // Build payload (fields align with backend RiskInput and email template)
    const payload = {
      recipient: email,
      subject: "Candoo: Your Operational Risk Report",

      industry: payroll.industry || workforce.industry || "",

      // Payroll
      improvement_rate: Number(payroll.improvement_rate || 0),
      avg_salary: Number(payroll.avg_salary || 0),
      total_employees: Number(payroll.total_employees || 0),

      // Workforce
      payroll_cost: Number(workforce.payroll_cost || 0),
      total_revenue: Number(workforce.total_revenue || 0),
      productive_hours: Number(workforce.productive_hours || 0),
      target_hours_per_employee: Number(workforce.target_hours_per_employee || 0),
      overtime_hours: Number(workforce.overtime_hours || 0),

      // Churn
      churn_rate: Number(churn.churn_rate || 0),
      desired_improvement: Number(churn.desired_improvement || 0),
      cac: Number(churn.cac || 0),
      avg_revenue: Number(churn.avg_revenue || 0),
      num_customers: Number(churn.num_customers || 0),

      // Leadership
      leadership_drag: Number(leadership.leadership_drag || 0),

      // Deep dive
      absenteeism_days: Number(deep.absenteeism_days || 0),
      avg_hours: Number(deep.avg_hours || 0)
    };

    // UI state
    feedback.textContent = "Generating report‚Ä¶";
    feedback.style.color = "#444";
    btn.disabled = true;

    try {
      const res = await fetch(`${BACKEND}/send-risk-report`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      let result = null;
      const ct = (res.headers.get("content-type") || "").toLowerCase();
      if (ct.includes("application/json")) {
        result = await res.json();
      } else {
        // fallback: text debug
        const txt = await res.text();
        result = { raw: txt };
      }
      console.log("üì¨ Server response:", result);

      // Save EBITDA-at-risk from the patched backend response
      // (Pro option: backend returns results.total_risk_dollars)
      const orsVal =
        (result && result.results && result.results.total_risk_dollars) ? result.results.total_risk_dollars : 0;
      saveOrsRisk(orsVal);

      if (res.ok) {
        feedback.textContent = "‚úÖ Report sent successfully!";
        feedback.style.color = "green";
        emailInput.value = "";
      } else {
        throw new Error((result && result.detail) || "Failed to send report.");
      }
    } catch (err) {
      console.error("‚ùå Fetch failed:", err);
      feedback.textContent = `‚ùå ${err.message}`;
      feedback.style.color = "red";
    } finally {
      btn.disabled = false;
    }
  });
</script>
